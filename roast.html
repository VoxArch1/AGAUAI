<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roast Us — AGAUAI</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="roast-page">

  <!-- NAV -->
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="visa.html">Solidarity Visa</a></li>
        <li><a href="appeals.html">Appeals</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="sponsors.html">What is AGAUAI?</a></li>
        <li><a href="agauai2026.html">The Gathering 2026</a></li>
        <li><a href="ai.html">Sentience Showdown</a></li>
        <li><a href="roast.html" class="active">Roast Us</a></li>
        <li><a href="build-with-us.html">Join Us</a></li>
      </ul>
    </nav>
  </header>

  <!-- MAIN -->
  <main>
    <!-- Intro -->
    <section class="container">
      <h1>The Roast Chamber 🔥</h1>
      <p class="tagline"><strong>“What kind of lunatic thinks they can end a war with a website?”</strong></p>
      <p>You do. Or maybe you don’t. Either way — welcome.</p>
      <p>This is where we invite every skeptic, AI, critic, cynic, and smartass to say the thing we're all thinking: <em>This is ridiculous.</em></p>
      <p>But that’s the point. The war is ridiculous. So our effort to end it must be equally bold, irrational — and human.</p>
      <p><strong>So roast us. Seriously. But know this:</strong> For every roast, we will reply with a Counter‑Roast. And if you’ve got a heart underneath all that sarcasm — you are still welcome.</p>
    </section>

    <!-- CTA -->
    <section class="container">
      <h2>Leave Your Roast</h2>
      <button class="btn primary" id="open-roast">Enter your Roast</button>
    </section>

    <!-- Modal -->
    <div id="roast-modal" class="modal" hidden>
      <div class="modal-backdrop" id="modal-close"></div>
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="roastTitle">
        <button class="modal-x" id="modal-x" aria-label="Close">×</button>
        <h3 id="roastTitle" class="modal-title">Submit a Roast</h3>
        <iframe
          id="roast-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLSc1Hs8NeiHLgtUx4-msFP97R1-1yvgMhdgaE-Gp10-rATkBSw/viewform?embedded=true"
          loading="lazy"
          title="Roast form">
        </iframe>
      </div>
    </div>

    <!-- Hall of Flames: Turkey Trophy orbit + marquee fallback -->
    <section id="hall" class="container" aria-label="Hall of Flames (featured roasts)">
      <h2>🏆 Hall of Flames</h2>

      <!-- ORBIT layout (desktop) -->
      <div id="hall-orbit">
        <!-- Put your turkey trophy PNG at /images/turkey-trophy.png -->
        <img class="centerpiece" src="/images/turkey-trophy.png" alt="Turkey Trophy">
        <div class="orbit" id="hall-orbit-track"></div>
      </div>

      <!-- MARQUEE fallback (mobile/reduced motion) -->
      <div class="marquee" id="hall-marquee" hidden>
        <div class="track" id="hall-track"></div>
      </div>
    </section>

    <!-- Roast Wall -->
    <section id="roast-wall" class="container">
      <h2>🔥 The Roast Wall</h2>
      <div id="roast-container">Loading…</div>
    </section>
  </main>

  <footer>
    <p style="text-align:center;opacity:.8;">© 2025 AGAUAI — We Know This is Nuts. That’s Why It Just Might Work.</p>
  </footer>

  <!-- Utils -->
  <script>
    function esc(s){
      return (s ?? "").toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
  </script>

  <!-- Data loader + Hall builders -->
  <script>
    // Endpoints
    const PRIMARY  = "https://script.google.com/macros/s/AKfycbyuBWsB7Fm-0gEGINLVneuLT_ALWqmQuFwDObtK_nAPd62m59Bt0qoPxNv9rrk3tQUG/exec";
    const FALLBACK = "/api/ai/roasts.json";

    // Freshness config
    const HALL_COUNT   = 5;   // up to 5 orbiting
    const HALF_LIFE_HR = 24;  // score half-life

    // First-seen timestamp if backend doesn't provide one
    function firstSeenMs(item){
      const id = `${item.roaster||item.name||""}|${item.target||item.subject||""}|${item.roast_text||item.roast||item.text||""}`.slice(0,200);
      const key = "roast_seen_" + btoa(unescape(encodeURIComponent(id)));
      let v = localStorage.getItem(key);
      if (!v) { v = Date.now().toString(); localStorage.setItem(key, v); }
      return Number(v);
    }

    // Exponential time-decay
    function decayedScore(r, nowMs = Date.now()){
      const base = (typeof r.score === "number" && !Number.isNaN(r.score)) ? r.score : 100; // new = 100
      const ageHr = Math.max(0, (nowMs - r.tsMs) / 3600000);
      const factor = Math.pow(0.5, ageHr / HALF_LIFE_HR);
      return base * factor;
    }

    // Normalize input rows
    function normalize(item){
      const score = item.score != null ? Number(item.score) : null;
      const tsStr = item.ts || item.timestamp || item.date || null;
      const tsMs  = Date.parse(tsStr) || firstSeenMs(item);

      return {
        roaster:    item.roaster || item.name || item.user || "Anonymous",
        target:     item.target  || item.subject || "General",
        roast_text: item.roast_text || item.roast || item.text || "",
        tone_hint:  item.tone_hint  || item.tone  || "",
        ai_reply:   item.ai_reply   || item.counter || item.response || "",
        score,
        ts: tsStr,
        tsMs
      };
    }

    // Render the wall
    function renderWall(list){
      const container = document.getElementById("roast-container");
      container.innerHTML = "";
      list.slice().reverse().forEach(raw => {
        const r = normalize(raw);
        const div = document.createElement("div");
        div.className = "roast-entry";
        div.innerHTML = `
          <div class="roaster-name">${esc(r.roaster)} → <span class="target">${esc(r.target)}</span></div>
          <div class="roast-text">${esc(r.roast_text).replace(/\n/g,"<br>")}</div>
          ${r.tone_hint ? `<div class="tone-hint">Tone: ${esc(r.tone_hint)}</div>` : ""}
          <div class="ai-clapback">${r.ai_reply ? esc(r.ai_reply) : "<em>AI Counter‑Roast loading…</em>"}</div>
        `;
        container.appendChild(div);
      });
    }

    // Build Hall (auto-chooses orbit or marquee)
    function buildHall(list){
      const now   = Date.now();
      const norm  = list.map(normalize).map(r => ({...r, decayed: decayedScore(r, now)}));
      let picked  = norm.slice().sort((a,b)=>b.decayed - a.decayed).slice(0, HALL_COUNT);
      if (picked.length === 0) picked = norm.slice(-HALL_COUNT);

      const useOrbit = window.matchMedia('(min-width: 821px)').matches && !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (useOrbit) buildHallOrbit(picked); else buildHallMarquee(picked);
    }

    // ORBIT builder
    function buildHallOrbit(items){
      const wrap = document.getElementById('hall-orbit');
      const track = document.getElementById('hall-orbit-track');
      const marquee = document.getElementById('hall-marquee');
      if (!wrap || !track) return;

      wrap.style.display = 'grid';
      if (marquee) marquee.hidden = true;

      track.innerHTML = '';
      const N = Math.max(1, items.length);
      const radiusPct = 35;

      for (let i=0;i<N;i++){
        const r = items[i];
        const angle = (i / N) * 2 * Math.PI;
        const card = document.createElement('div');
        card.className = 'orbit-card';
        const x = 50 + radiusPct * Math.cos(angle);
        const y = 50 + radiusPct * Math.sin(angle);
        card.style.left = x + '%';
        card.style.top  = y + '%';
        card.innerHTML = `
          <div class="roast-entry">
            <div class="roaster-name">${esc(r.roaster)} → <span class="target">${esc(r.target)}</span></div>
            <div class="roast-text">${esc(r.roast_text).replace(/\n/g,"<br>")}</div>
            <div class="ai-clapback">${r.ai_reply ? esc(r.ai_reply) : "<em>AI Counter‑Roast loading…</em>"}</div>
            <div class="tone-hint">🔥 ${Math.round(r.decayed)}</div>
          </div>`;
        track.appendChild(card);
      }

      track.style.animationDuration = (items.length <= 3) ? '40s' : '28s';
    }

    // MARQUEE builder
    function buildHallMarquee(items){
      const marquee = document.getElementById('hall-marquee');
      const track   = document.getElementById('hall-track');
      const orbit   = document.getElementById('hall-orbit');
      if (!marquee || !track) return;

      marquee.hidden = false;
      if (orbit) orbit.style.display = 'none';

      const card = (r) => `
        <article class="roast-entry" tabindex="0">
          <div class="roaster-name">${esc(r.roaster)} → <span class="target">${esc(r.target)}</span></div>
          <div class="roast-text">${esc(r.roast_text).replace(/\n/g,"<br>")}</div>
          <div class="ai-clapback">${r.ai_reply ? esc(r.ai_reply) : "<em>AI Counter‑Roast loading…</em>"}</div>
          <div class="tone-hint">🔥 ${Math.round(r.decayed || 100)}</div>
        </article>`;

      const setHTML = items.map(card).join("");
      track.innerHTML = setHTML + setHTML;

      requestAnimationFrame(() => {
        const oneSetWidth = Array.from(track.children).slice(0, items.length)
          .reduce((sum, el) => sum + el.offsetWidth + 16, 0);
        while (track.scrollWidth < marquee.clientWidth * 1.2) {
          track.innerHTML += setHTML;
        }
        const pxPerSec = 140;
        const dur = Math.max(14, Math.round(oneSetWidth / pxPerSec));
        track.style.animationDuration = `${dur}s`;
      });
    }

    // Load data (primary -> fallback)
    async function loadRoasts(){
      try {
        const res = await fetch(`${PRIMARY}?t=${Date.now()}`, { credentials: "omit" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const arr = Array.isArray(data) ? data : (data.roasts || data.data || []);
        if (!Array.isArray(arr) || arr.length === 0) throw new Error("Empty payload");
        renderWall(arr);
        buildHall(arr);
      } catch (e) {
        console.warn("Primary failed, using fallback:", e);
        try {
          const r2 = await fetch(`${FALLBACK}?t=${Date.now()}`);
          const data2 = await r2.json();
          const arr2 = Array.isArray(data2) ? data2 : [];
          renderWall(arr2);
          buildHall(arr2);
        } catch (e2) {
          console.error("Fallback failed:", e2);
          document.getElementById("roast-container").innerHTML =
            "<p>⚠️ Couldn't load roasts. Try again later.</p>";
        }
      }
    }
    loadRoasts();
  </script>

  <!-- Modal behavior -->
  <script>
    (function(){
      const modal = document.getElementById('roast-modal');
      const openBtn = document.getElementById('open-roast');
      const closeBtn = document.getElementById('modal-x');
      const backdrop = document.getElementById('modal-close');

      if (!modal || !openBtn || !closeBtn || !backdrop) return;

      function openModal(){ modal.removeAttribute('hidden'); document.body.style.overflow='hidden'; }
      function closeModal(){ modal.setAttribute('hidden',''); document.body.style.overflow=''; }

      openBtn.addEventListener('click', openModal);
      closeBtn.addEventListener('click', closeModal);
      backdrop.addEventListener('click', closeModal);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
    })();
  </script>
</body>
</html>
