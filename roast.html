<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roast Us ‚Äî AGAUAI</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* Layout containers */
    #hall, #roast-wall { max-width: 960px; margin: 2rem auto; padding: 0 1rem; color: #fff; }

    /* Roast cards */
    .roast-entry {
      border-left: 4px solid #ff5555;
      margin: 1.25rem 0 2rem;
      background: linear-gradient(180deg, #121212 0%, #0f0f0f 100%);
      border-radius: 10px;
      padding: 1rem 1.1rem 1.1rem;
      box-shadow: 0 6px 20px rgba(0,0,0,0.28);
    }
    .roaster-name { color:#0bf; font-size:.92rem; font-weight:700; letter-spacing:.2px; }
    .roast-text { font-size:1.15rem; color:#ffd700; margin:.5rem 0 .35rem; line-height:1.45; }
    .ai-clapback, .ai-response { font-style:italic; color:#66ccff; font-size:.975rem; }
    .roaster-name .target { opacity:.8; }
    .tone-hint { font-size:.85rem; color:#9aa; margin:4px 0 6px; }

    /* Section headings */
    h2 { margin-bottom: .6rem; }

    /* Button (if global .btn missing) */
    .btn { border-radius: 999px; padding: .7rem 1.1rem; font-weight: 700; cursor: pointer; border: none; }
    .btn.primary { background: #0bf; color: #001018; box-shadow: 0 10px 30px rgba(0,187,255,.25); }
    .btn.primary:hover { transform: translateY(-2px); transition: transform 150ms ease; }

    /* Invite attention to the CTA */
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 8px rgba(0,187,255,.5), 0 0 16px rgba(0,187,255,.3); }
      50% { box-shadow: 0 0 12px rgba(0,187,255,.8), 0 0 24px rgba(0,187,255,.5); }
      100% { box-shadow: 0 0 8px rgba(0,187,255,.5), 0 0 16px rgba(0,187,255,.3); }
    }
    #open-roast { animation: pulseGlow 2s infinite; }

    /* Modal */
    .modal[hidden] { display: none !important; }
    .modal { position: fixed; inset: 0; z-index: 9999; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.65); backdrop-filter: blur(2px); }
    .modal-dialog {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
      width: min(92vw, 760px); max-height: 85vh; background: #0a0a0a;
      border: 1px solid #222; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,.6);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-title { margin: 0; padding: .9rem 1.1rem; border-bottom: 1px solid #1a1a1a; color:#ffd700; font-weight:700; }
    .modal-x {
      position: absolute; right: 8px; top: 6px; width: 36px; height: 36px;
      background: transparent; color: #ccc; font-size: 1.6rem; cursor: pointer; border:0; font-weight:700;
    }
    .modal-x:hover { color: #fff; }
    #roast-frame { border: 0; width: 100%; height: calc(85vh - 58px); background: #111; }

    /* Hall container look */
    #hall { background: linear-gradient(180deg, #1b1b1b 0%, #111 100%); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); padding: 1rem; }

    /* Hall marquee */
    #hall .marquee { position: relative; overflow: hidden; width: 100%; border-radius: 8px; }
    #hall .track { display: inline-flex; gap: 16px; will-change: transform; animation: hallScroll 28s linear infinite; }
    #hall .marquee:hover .track, #hall .marquee:focus-within .track { animation-play-state: paused; }
    @keyframes hallScroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }
    @media (prefers-reduced-motion: reduce) { #hall .track { animation: none; } }

    /* Marquee card sizing (compact) */
    #hall .roast-entry { min-width: 320px; max-width: 420px; margin: 0; padding: .9rem 1rem; }
    #hall .roast-text { font-size: 1rem; line-height: 1.35; }
    #hall .ai-clapback { font-size: .95rem; }

    @media (max-width: 520px) {
      .modal-dialog { width: 94vw; max-height: 88vh; }
      #roast-frame { height: calc(88vh - 58px); }
    }
  </style>
</head>
<body class="roast-page">

  <!-- NAV -->
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="visa.html">Solidarity Visa</a></li>
        <li><a href="appeals.html">Appeals</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="sponsors.html">What is AGAUAI?</a></li>
        <li><a href="agauai2026.html">The Gathering 2026</a></li>
        <li><a href="ai.html">Sentience Showdown</a></li>
        <li><a href="roast.html" class="active">Roast Us</a></li>
        <li><a href="build-with-us.html">Join Us</a></li>
      </ul>
    </nav>
  </header>

  <!-- MAIN -->
  <main>
    <section style="max-width:960px;margin:2rem auto;padding:0 1rem;">
      <h1>The Roast Chamber üî•</h1>
      <p class="tagline"><strong>‚ÄúWhat kind of lunatic thinks they can end a war with a website?‚Äù</strong></p>
      <p>You do. Or maybe you don‚Äôt. Either way ‚Äî welcome.</p>
      <p>This is where we invite every skeptic, AI, critic, cynic, and smartass to say the thing we're all thinking: <em>This is ridiculous.</em></p>
      <p>But that‚Äôs the point. The war is ridiculous. So our effort to end it must be equally bold, irrational ‚Äî and human.</p>
      <p><strong>So roast us. Seriously. But know this:</strong> For every roast, we will reply with a Counter‚ÄëRoast. And if you‚Äôve got a heart underneath all that sarcasm ‚Äî you are still welcome.</p>
    </section>

    <section style="max-width:960px;margin:0 auto;padding:0 1rem;">
      <h2>Leave Your Roast</h2>
      <button class="btn primary" id="open-roast">Enter your Roast</button>
    </section>

    <!-- Modal -->
    <div id="roast-modal" class="modal" hidden>
      <div class="modal-backdrop" id="modal-close"></div>
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="roastTitle">
        <button class="modal-x" id="modal-x" aria-label="Close">√ó</button>
        <h3 id="roastTitle" class="modal-title">Submit a Roast</h3>
        <iframe
          id="roast-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLSc1Hs8NeiHLgtUx4-msFP97R1-1yvgMhdgaE-Gp10-rATkBSw/viewform?embedded=true"
          loading="lazy"
          title="Roast form">
        </iframe>
      </div>
    </div>

    <!-- Hall -->
    <section id="hall" aria-label="Hall of Flames (featured roasts)">
      <h2>üèÜ Hall of Flames</h2>
      <div class="marquee" id="hall-marquee">
        <div class="track" id="hall-track"></div>
      </div>
    </section>

    <!-- Wall -->
    <section id="roast-wall">
      <h2>üî• The Roast Wall</h2>
      <div id="roast-container">Loading‚Ä¶</div>
    </section>
  </main>

  <footer>
    <p style="text-align:center;opacity:.8;">¬© 2025 AGAUAI ‚Äî We Know This is Nuts. That‚Äôs Why It Just Might Work.</p>
  </footer>

  <!-- Utils -->
  <script defer>
    function esc(s){
      return (s ?? "").toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
  </script>

  <!-- Loader -->
  <script defer>
    const PRIMARY  = "https://script.google.com/macros/s/AKfycbyuBWsB7Fm-0gEGINLVneuLT_ALWqmQuFwDObtK_nAPd62m59Bt0qoPxNv9rrk3tQUG/exec";
    const FALLBACK = "/api/ai/roasts.json";

    /* ==== FRESHNESS CONFIG & HELPERS ==== */
    const HALL_COUNT   = 3;     // how many to feature
    const HALF_LIFE_HR = 24;    // half-life for score decay

    function firstSeenMs(item){
      const id = `${item.roaster||item.name||""}|${item.target||item.subject||""}|${item.roast_text||item.roast||item.text||""}`.slice(0,200);
      const key = "roast_seen_" + btoa(unescape(encodeURIComponent(id)));
      let v = localStorage.getItem(key);
      if (!v) { v = Date.now().toString(); localStorage.setItem(key, v); }
      return Number(v);
    }

    function decayedScore(r, nowMs = Date.now()){
      const base = (typeof r.score === "number" && !Number.isNaN(r.score)) ? r.score : 100; // new = 100
      const ageHr = Math.max(0, (nowMs - r.tsMs) / 3600000);
      const factor = Math.pow(0.5, ageHr / HALF_LIFE_HR);
      return base * factor;
    }
    /* ==================================== */

    function normalize(item){
      const score = item.score != null ? Number(item.score) : null;
      const tsStr = item.ts || item.timestamp || item.date || null;
      const tsMs  = Date.parse(tsStr) || firstSeenMs(item); // fallback to first-seen if missing

      return {
        roaster:    item.roaster || item.name || item.user || "Anonymous",
        target:     item.target  || item.subject || "General",
        roast_text: item.roast_text || item.roast || item.text || "",
        tone_hint:  item.tone_hint  || item.tone  || "",
        ai_reply:   item.ai_reply   || item.counter || item.response || "",
        score,
        ts: tsStr,
        tsMs
      };
    }

    function render(list){
      const container = document.getElementById("roast-container");
      container.innerHTML = "";
      list.slice().reverse().forEach(raw => {
        const r = normalize(raw);
        const div = document.createElement("div");
        div.className = "roast-entry";
        div.innerHTML = `
          <div class="roaster-name">${esc(r.roaster)} ‚Üí <span class="target">${esc(r.target)}</span></div>
          <div class="roast-text">${esc(r.roast_text).replace(/\n/g,"<br>")}</div>
          ${r.tone_hint ? `<div class="tone-hint">Tone: ${esc(r.tone_hint)}</div>` : ""}
          <div class="ai-clapback">${r.ai_reply ? esc(r.ai_reply) : "<em>AI Counter‚ÄëRoast loading‚Ä¶</em>"}</div>
        `;
        container.appendChild(div);
      });
    }

    /* === HALL OF FLAMES (marquee with time-decay freshness) === */
    function buildHall(list){
      const marquee = document.getElementById("hall-marquee");
      const track   = document.getElementById("hall-track");
      if (!marquee || !track) return;

      const now  = Date.now();
      const norm = list.map(normalize).map(r => ({...r, decayed: decayedScore(r, now)}));

      // Pick top by decayed score; if too few, latest by timestamp
      let picked = norm.slice().sort((a,b) => b.decayed - a.decayed).slice(0, HALL_COUNT);
      if (picked.length === 0) {
        picked = norm
          .map((r,i)=>({r,i, t: r.tsMs || i}))
          .sort((a,b)=>(b.t||0)-(a.t||0))
          .slice(0, HALL_COUNT)
          .map(x=>x.r);
      }

      const cardHTML = (r) => `
        <article class="roast-entry" tabindex="0">
          <div class="roaster-name">${esc(r.roaster)} ‚Üí <span class="target">${esc(r.target)}</span></div>
          <div class="roast-text">${esc(r.roast_text).replace(/\n/g,"<br>")}</div>
          <div class="ai-clapback">${r.ai_reply ? esc(r.ai_reply) : "<em>AI Counter‚ÄëRoast loading‚Ä¶</em>"}</div>
          <div class="tone-hint">üî• ${Math.round(r.decayed || decayedScore(r))}</div>
        </article>
      `;

      const setHTML = picked.map(cardHTML).join("");
      track.innerHTML = setHTML + setHTML; // two copies for seamless loop

      // Adjust animation duration to actual width
      requestAnimationFrame(() => {
        const totalWidth = Array.from(track.children)
          .slice(0, picked.length) // width of one set
          .reduce((sum, el) => sum + el.offsetWidth + 16 /*gap*/, 0);

        // If one set is narrower than the marquee, repeat until it's wide enough
        while (track.scrollWidth < marquee.clientWidth * 1.2) {
          track.innerHTML += setHTML;
        }

        const pxPerSec = 140; // speed control
        const durationSec = Math.max(14, Math.round(totalWidth / pxPerSec));
        track.style.animationDuration = `${durationSec}s`;
      });
    }
    /* ========================================================= */

    async function loadRoasts(){
      try {
        const res = await fetch(`${PRIMARY}?t=${Date.now()}`, { credentials: "omit" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const arr = Array.isArray(data) ? data : (data.roasts || data.data || []);
        if (!Array.isArray(arr) || arr.length === 0) throw new Error("Empty payload");
        render(arr);
        buildHall(arr);
      } catch (e) {
        console.warn("Primary failed, using fallback:", e);
        try {
          const r2 = await fetch(`${FALLBACK}?t=${Date.now()}`);
          const data2 = await r2.json();
          const arr2 = Array.isArray(data2) ? data2 : [];
          render(arr2);
          buildHall(arr2);
        } catch (e2) {
          console.error("Fallback failed:", e2);
          document.getElementById("roast-container").innerHTML =
            "<p>‚ö†Ô∏è Couldn't load roasts. Try again later.</p>";
        }
      }
    }
    loadRoasts();
  </script>

  <!-- Modal behavior -->
  <script>
    (function(){
      const modal = document.getElementById('roast-modal');
      const openBtn = document.getElementById('open-roast');
      const closeBtn = document.getElementById('modal-x');
      const backdrop = document.getElementById('modal-close');

      if (!modal || !openBtn || !closeBtn || !backdrop) return;

      function openModal(){ modal.removeAttribute('hidden'); document.body.style.overflow='hidden'; }
      function closeModal(){ modal.setAttribute('hidden',''); document.body.style.overflow=''; }

      openBtn.addEventListener('click', openModal);
      closeBtn.addEventListener('click', closeModal);
      backdrop.addEventListener('click', closeModal);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
    })();
  </script>
</body>
</html>

  
</body>
</html>
