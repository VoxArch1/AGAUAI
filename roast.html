<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roast Us ‚Äî AGAUAI</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* minimal helpers; move to style.css whenever */
    .container{max-width:960px;margin:2rem auto;padding:0 1rem}
    .btn{border:none;border-radius:999px;padding:.7rem 1.1rem;font-weight:700;cursor:pointer}
    .btn.primary{background:#0bf;color:#001018}

    /* Roast cards (theme‚Äëfriendly) */
    .roast-entry{border-left:4px solid #ff5555;background:linear-gradient(180deg,#121212,#0f0f0f);border-radius:10px;padding:1rem 1.1rem;box-shadow:0 6px 20px rgba(0,0,0,.28);margin:1.25rem 0 2rem}
    .roaster-name{color:#0bf;font-weight:700;font-size:.95rem}
    .roast-text{color:#ffd700;font-size:1.1rem;margin:.5rem 0 .35rem;line-height:1.45}
    .ai-clapback{font-style:italic;color:#66ccff}
    .tone-hint{color:#9aa;font-size:.85rem;margin-top:.35rem}

    /* Modal */
    .modal[hidden]{display:none!important}.modal{position:fixed;inset:0;z-index:9999}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(2px)}
    .modal-dialog{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,760px);max-height:85vh;background:#0a0a0a;border:1px solid #222;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden}
    .modal-title{margin:0;padding:.9rem 1.1rem;border-bottom:1px solid #1a1a1a;color:#ffd700;font-weight:700}
    .modal-x{position:absolute;right:8px;top:6px;width:36px;height:36px;background:transparent;border:0;color:#ccc;font-size:1.6rem;cursor:pointer}
    #roast-frame{border:0;width:100%;height:calc(85vh - 58px);background:#111}

    /* Hall container */
    #hall{background:linear-gradient(180deg,#1b1b1b,#111);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.4);padding:1rem}

    /* 3D cylinder */
    #hall-3d{position:relative;perspective:1100px;perspective-origin:50% 45%}
    #hall-stage{position:relative;transform-style:preserve-3d;z-index:5;height:460px}
    #hall-3d .centerpiece{
      position:absolute;left:50%;top:50%;
      transform: translate(-50%,-55%) translateZ(-150px); /* behind */
      z-index:1; pointer-events:none;
      width:min(32vmin,320px);
      filter:drop-shadow(0 8px 18px rgba(0,0,0,.55));
    }
    .card{position:absolute;transform-origin:center center;will-change:transform,opacity}

    /* Slightly smaller text inside the Hall only */
    #hall .roast-entry { padding:.8rem .9rem; }
    #hall .roast-entry .roaster-name { font-size:.9rem; }
    #hall .roast-entry .roast-text { font-size:clamp(.90rem,1.6vw,1.02rem); line-height:1.4; }
    #hall .roast-entry .ai-clapback { font-size:.95rem; }
    #hall .roast-entry .tone-hint { font-size:.80rem; }

    /* Marquee fallback */
    #hall .marquee{position:relative;overflow:hidden;border-radius:8px}
    #hall .track{display:inline-flex;gap:16px;will-change:transform;animation:hallScroll 28s linear infinite}
    #hall .track:hover{animation-play-state:paused;} /* pause on hover */
    @keyframes hallScroll{from{transform:translateX(0)}to{transform:translateX(-50%)}}

    /* Auto-fallback */
    @media (max-width:820px){#hall-3d{display:none}#hall-marquee{display:block!important}}
    @media (prefers-reduced-motion:reduce){#hall-3d{display:none}#hall-marquee{display:block!important}}
  </style>
</head>
<body class="roast-page">

  <!-- NAV -->
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="visa.html">Solidarity Visa</a></li>
        <li><a href="appeals.html">Appeals</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="sponsors.html">What is AGAUAI?</a></li>
        <li><a href="agauai2026.html">The Gathering 2026</a></li>
        <li><a href="ai.html">Sentience Showdown</a></li>
        <li><a href="roast.html" class="active">Roast Us</a></li>
        <li><a href="build-with-us.html">Join Us</a></li>
      </ul>
    </nav>
  </header>

  <!-- MAIN -->
  <main>
    <!-- Intro -->
    <section class="container">
      <h1>The Roast Chamber üî•</h1>
      <p class="tagline"><strong>‚ÄúWhat kind of lunatic thinks they can end a war with a website?‚Äù</strong></p>
      <p>You do. Or maybe you don‚Äôt. Either way ‚Äî welcome.</p>
      <p>This is where we invite every skeptic, AI, critic, cynic, and smartass to say the thing we're all thinking: <em>This is ridiculous.</em></p>
      <p>But that‚Äôs the point. The war is ridiculous. So our effort to end it must be equally bold, irrational ‚Äî and human.</p>
      <p><strong>So roast us. Seriously. But know this:</strong> For every roast, we will reply with a Counter‚ÄëRoast. And if you‚Äôve got a heart underneath all that sarcasm ‚Äî you are still welcome.</p>
    </section>

    <!-- CTA -->
    <section class="container">
      <h2>Leave Your Roast</h2>
      <button class="btn primary" id="open-roast">Enter your Roast</button>
    </section>

    <!-- Modal -->
    <div id="roast-modal" class="modal" hidden>
      <div class="modal-backdrop" id="modal-close"></div>
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="roastTitle">
        <button class="modal-x" id="modal-x" aria-label="Close">√ó</button>
        <h3 id="roastTitle" class="modal-title">Submit a Roast</h3>
        <iframe
          id="roast-frame"
          src="https://docs.google.com/forms/d/e/1FAIpQLSc1Hs8NeiHLgtUx4-msFP97R1-1yvgMhdgaE-Gp10-rATkBSw/viewform?embedded=true"
          loading="lazy"
          title="Roast form">
        </iframe>
      </div>
    </div>

    <!-- Hall of Flames -->
    <section id="hall" class="container" aria-label="Hall of Flames (featured roasts)">
      <h2>üèÜ Hall of Flames</h2>

      <!-- 3D cylinder (desktop) -->
      <div id="hall-3d">
        <img class="centerpiece" src="/images/turkey-trophy.png" alt="Turkey Trophy">
        <div class="stage" id="hall-stage"></div>
      </div>

      <!-- Marquee fallback -->
      <div class="marquee" id="hall-marquee" hidden>
        <div class="track" id="hall-track"></div>
      </div>
    </section>

    <!-- Roast Wall -->
    <section id="roast-wall" class="container">
      <h2>üî• The Roast Wall</h2>
      <div id="roast-container">Loading‚Ä¶</div>
    </section>
  </main>

  <footer>
    <p style="text-align:center;opacity:.8;">¬© 2025 AGAUAI ‚Äî We Know This is Nuts. That‚Äôs Why It Just Might Work.</p>
  </footer>

  <!-- ==== JS ==== -->
  <script>
    /* Utils */
    function esc(s){
      return (s ?? "").toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }

    /* Endpoints */
    const PRIMARY  = "https://script.google.com/macros/s/AKfycbyuBWsB7Fm-0gEGINLVneuLT_ALWqmQuFwDObtK_nAPd62m59Bt0qoPxNv9rrk3tQUG/exec";
    const FALLBACK = "/api/ai/roasts.json";

    /* Freshness config */
    const HALL_COUNT   = 7;    // up to 7 around the ring
    const HALF_LIFE_HR = 24;   // score half-life

    function firstSeenMs(item){
      const id = `${item.roaster||item.name||""}|${item.target||item.subject||""}|${item.roast_text||item.roast||item.text||""}`.slice(0,200);
      const key = "roast_seen_" + btoa(unescape(encodeURIComponent(id)));
      let v = localStorage.getItem(key);
      if (!v) { v = Date.now().toString(); localStorage.setItem(key, v); }
      return Number(v);
    }

    function decayedScore(r, nowMs = Date.now()){
      const base = (typeof r.score === "number" && !Number.isNaN(r.score)) ? r.score : 100; // new = 100
      const ageHr = Math.max(0, (nowMs - r.tsMs) / 3600000);
      const factor = Math.pow(0.5, ageHr / HALF_LIFE_HR);
      return base * factor;
    }

    function normalize(item){
      const score = item.score != null ? Number(item.score) : null;
      const tsStr = item.ts || item.timestamp || item.date || null;
      const tsMs  = Date.parse(tsStr) || firstSeenMs(item);
      return {
        roaster:    item.roaster || item.name || item.user || "Anonymous",
        target:     item.target  || item.subject || "General",
        roast_text: item.roast_text || item.roast || item.text || "",
        tone_hint:  item.tone_hint  || item.tone  || "",
        ai_reply:   item.ai_reply   || item.counter || item.response || "",
        score, ts: tsStr, tsMs
      };
    }

    /* ---- Roast Wall ---- */
    function renderWall(list){
      const container = document.getElementById("roast-container");
      container.innerHTML = "";
      list.slice().reverse().forEach(raw => {
        const r = normalize(raw);
        const div = document.createElement("div");
        div.className = "roast-entry";
        div.innerHTML = `
          <div class="roaster-name">${esc(r.roaster)} ‚Üí <span class="target">${esc(r.target)}</span></div>
          <div class="roast-text">${esc(r.roast_text).replace(/\n/g,"<br>")}</div>
          ${r.tone_hint ? `<div class="tone-hint">Tone: ${esc(r.tone_hint)}</div>` : ""}
          <div class="ai-clapback">${r.ai_reply ? esc(r.ai_reply) : "<em>AI Counter‚ÄëRoast loading‚Ä¶</em>"}</div>
        `;
        container.appendChild(div);
      });
    }

    /* ---- Hall chooser ---- */
    function buildHall(list){
      const now  = Date.now();
      const norm = list.map(normalize).map(r => ({...r, decayed: decayedScore(r, now)}));
      let picked = norm.slice().sort((a,b)=>b.decayed - a.decayed).slice(0, HALL_COUNT);
      if (picked.length === 0) picked = norm.slice(-5);

      const use3D = window.matchMedia('(min-width: 821px)').matches &&
                    !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (use3D) buildHall3D(picked); else buildHallMarquee(picked);
    }

    /* ---- 3D CYLINDER (centered on the turkey) ---- */
    function buildHall3D(items){
      const wrap   = document.getElementById('hall-3d');
      const stage  = document.getElementById('hall-stage');
      const mq     = document.getElementById('hall-marquee');
      const turkey = wrap?.querySelector('.centerpiece');
      if (!wrap || !stage || !turkey) return;

      // show 3D, hide marquee
      wrap.style.display = 'block';
      if (mq) mq.hidden = true;

      // reset stage
      stage.innerHTML = '';
      stage.style.position = 'relative';
      stage.style.transformStyle = 'preserve-3d';

      // compact stage height
      const tH = turkey.naturalHeight || turkey.clientHeight || 320;
      const desired = Math.min(420, Math.max(320, Math.round(tH * 0.95)));
      stage.style.height = desired + 'px';

      // build cards
      const N = Math.max(1, items.length);
      const nodes = [];
      for (let i=0;i<N;i++){
        const r = items[i];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="roast-entry">
            <div class="roaster-name">${esc(r.roaster)} ‚Üí <span class="target">${esc(r.target)}</span></div>
            <div class="roast-text">${esc(r.roast_text).replace(/\n/g,"<br>")}</div>
            <div class="ai-clapback">${r.ai_reply ? esc(r.ai_reply) : "<em>AI Counter‚ÄëRoast loading‚Ä¶</em>"}</div>
            <div class="tone-hint">üî• ${Math.round(r.decayed ?? 100)}</div>
          </div>`;
        stage.appendChild(card);
        nodes.push({ el: card, baseAngle: (i / N) * (Math.PI * 2) });
      }

      const baseSpeed = 0.50;      // smooth
      let paused = false;
      wrap.addEventListener('pointerenter', () => paused = true);
      wrap.addEventListener('pointerleave', () => paused = false);

     let lastTs = null;
let rotationOffset = 0; // keep track of total rotation

function frame(ts){
  if (lastTs === null) lastTs = ts;
  const deltaSec = (ts - lastTs) / 1000;
  lastTs = ts;

  // only advance rotation if not paused
  if (!paused) {
    rotationOffset += deltaSec * baseSpeed;
  }

  // center on the TURKEY
  const stRect = stage.getBoundingClientRect();
  const tkRect = turkey.getBoundingClientRect();
  const cx = (tkRect.left - stRect.left) + tkRect.width / 2;
  const cy = (tkRect.top  - stRect.top)  + tkRect.height * 0.50;

  // cylinder radii (clamped)
  const tw = tkRect.width;
  const R = Math.min(260, Math.max(180, tw * 0.62));
  const D = Math.min(220, Math.max(140, R  * 0.75));
  const Y = 0;

  for (const n of nodes){
    const a = n.baseAngle + rotationOffset;
    const x = R * Math.cos(a);
    const z = D * Math.sin(a);
    const y = Y;

    const rotY = 0; // face viewer
    const zNorm = (z + D) / (2*D);
    const scaleX = 0.88 + zNorm * 0.30;      // tweak 0.30 if you want more/less width swing
    const scaleY = 1;
    const scaleY = 0.88 + zNorm * 0.30;
    const opacity = 0.50 + zNorm * 0.50;

    n.el.style.transform =
      `translate3d(${cx + x}px, ${cy + y}px, ${z}px) rotateY(${rotY}deg) translate(-50%,-50%) scale(${scaleX}, ${scaleY})`;
    n.el.style.opacity = opacity.toFixed(3);
    n.el.style.zIndex = String(1000 + Math.round(z));
    n.el.style.pointerEvents = (z > 0) ? 'auto' : 'none';
  }

  requestAnimationFrame(frame);
}
      requestAnimationFrame(frame);
    }

    /* ---- Marquee fallback ---- */
    function buildHallMarquee(items){
      const marquee = document.getElementById('hall-marquee');
      const track   = document.getElementById('hall-track');
      const orbit   = document.getElementById('hall-3d');
      if (!marquee || !track) return;

      marquee.hidden = false;
      if (orbit) orbit.style.display = 'none';

      const card = (r) => `
        <article class="roast-entry" tabindex="0">
          <div class="roaster-name">${esc(r.roaster)} ‚Üí <span class="target">${esc(r.target)}</span></div>
          <div class="roast-text">${esc(r.roast_text).replace(/\n/g,"<br>")}</div>
          <div class="ai-clapback">${r.ai_reply ? esc(r.ai_reply) : "<em>AI Counter‚ÄëRoast loading‚Ä¶</em>"}</div>
          <div class="tone-hint">üî• ${Math.round(r.decayed || 100)}</div>
        </article>`;

      const setHTML = items.map(card).join("");
      track.innerHTML = setHTML + setHTML;

      requestAnimationFrame(() => {
        const oneSetWidth = Array.from(track.children).slice(0, items.length)
          .reduce((sum, el) => sum + el.offsetWidth + 16, 0);
        while (track.scrollWidth < marquee.clientWidth * 1.2) {
          track.innerHTML += setHTML;
        }
        const pxPerSec = 140;
        const dur = Math.max(14, Math.round(oneSetWidth / pxPerSec));
        track.style.animationDuration = `${dur}s`;
      });
    }

    /* ---- Data load ---- */
    async function loadRoasts(){
      try {
        const res = await fetch(`${PRIMARY}?t=${Date.now()}`, { credentials: "omit" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const arr = Array.isArray(data) ? data : (data.roasts || data.data || []);
        if (!Array.isArray(arr) || arr.length === 0) throw new Error("Empty payload");
        renderWall(arr);
        buildHall(arr);
      } catch (e) {
        console.warn("Primary failed, using fallback:", e);
        try {
          const r2 = await fetch(`${FALLBACK}?t=${Date.now()}`);
          const data2 = await r2.json();
          const arr2 = Array.isArray(data2) ? data2 : [];
          renderWall(arr2);
          buildHall(arr2);
        } catch (e2) {
          console.error("Fallback failed:", e2);
          document.getElementById("roast-container").innerHTML =
            "<p>‚ö†Ô∏è Couldn't load roasts. Try again later.</p>";
        }
      }
    }
    loadRoasts();

    /* ---- Modal behavior ---- */
    (function(){
      const modal = document.getElementById('roast-modal');
      const openBtn = document.getElementById('open-roast');
      const closeBtn = document.getElementById('modal-x');
      const backdrop = document.getElementById('modal-close');
      if (!modal || !openBtn || !closeBtn || !backdrop) return;
      function openModal(){ modal.removeAttribute('hidden'); document.body.style.overflow='hidden'; }
      function closeModal(){ modal.setAttribute('hidden',''); document.body.style.overflow=''; }
      openBtn.addEventListener('click', openModal);
      closeBtn.addEventListener('click', closeModal);
      backdrop.addEventListener('click', closeModal);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
    })();
  </script>
</body>
</html>

